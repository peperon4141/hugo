<!doctype html><html lang><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>DockerでRubyOnRails環境を構築 - こつこつナレッジ</title><meta name=description content="はじめに RubyOnRailsの学習のために、すぐにクリーンな環境を作り直せるDockerで環境構築をしていきます。
DockerDesktopはインストール前提です。
ファイルを作成 新規でディレクトリを作成します。
そのディレクトリに、以下の構成になるようにファイルを作成していきます。
. ├── Dockerfile ├── Gemfile ├── Gemfile.lock ├── docker-compose.yml └── entrypoint.sh Dockerfile作成 Dockerfileという名前でファイルを作成し、以下を記述します。
FROM ruby:2.7.0 # yarnをインストール RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - && \ echo &#34;deb https://dl.yarnpkg.com/debian/ stable main&#34; | tee /etc/apt/sources.list.d/yarn.list # モジュールインストール RUN apt-get update -qq && apt-get install -y nodejs yarn # rails_appディレクトリを作成し、作業ディレクトリにする RUN mkdir /rails_app WORKDIR /rails_app # GemfileとGemfile.lockをコピーして、bundlerでインストールする COPY Gemfile /rails_app/Gemfile COPY Gemfile.lock /rails_app/Gemfile.lock RUN bundle install COPY ."><meta name=author content><link rel=stylesheet href=https://tech.choihack.com/css/style.5e3c1b94e7a3169da08d890a552f1f5104fb412b9941455faeaa419605a355f5.css><link href=https://tech.choihack.com/custom.css rel=stylesheet><link rel=apple-touch-icon href=https://tech.choihack.com/apple-touch-icon.png><link rel=icon href=https://tech.choihack.com/favicon.ico><meta name=generator content="Hugo 0.85.0"><script async src="https://www.googletagmanager.com/gtag/js?id=G-V3H6ME1VJT"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-V3H6ME1VJT',{anonymize_ip:!1})}</script><meta property="og:title" content="DockerでRubyOnRails環境を構築"><meta property="og:description" content="DockerでRubyOnRails環境を構築"><meta property="og:type" content="article"><meta property="og:url" content="https://tech.choihack.com/post/rubyonrails/docker%E3%81%A7rubyonrails%E7%92%B0%E5%A2%83%E3%82%92%E6%A7%8B%E7%AF%89/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-08-01T15:49:59+09:00"><meta property="article:modified_time" content="2021-08-01T15:49:59+09:00"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7379986362181342" crossorigin=anonymous></script><script>window.onload=function(){var a=Array.prototype.slice.call(document.querySelectorAll("pre"),0);a.forEach(function(b){var c=b.firstElementChild,d=c.dataset.lang,e=d?d.split(":")[1]:null,a;e&&(a=document.createElement('div'),a.textContent=e,a.classList.add('code-name'),b.insertBefore(a,c))})}</script></head><header class=header><nav class=nav><h1 class=logo><a href=https://tech.choihack.com/>こつこつナレッジ</a></h1><ul class=menu><li><a href=/>TOP</a></li><li><a href=/post/hugo>Hugo</a></li><li><a href=/post/gas>GAS</a></li><li><a href=/post/tradingview>TradingView</a></li><li><a href=/post/wordpress>WordPress</a></li><li><a href=/post/rubyonrails>RubyOnRails</a></li><li><a href=/post/gcp>GCP</a></li><li><a href=/post/others>雑記</a></li><li><a href=/search>検索</a></li></ul></nav><nav class=breadcrumb><ul><li><a href=https://tech.choihack.com/>TOP</a></li><li><a href=https://tech.choihack.com/post/>投稿</a></li><li><a href=https://tech.choihack.com/post/rubyonrails/>RubyOnRails</a></li><li class=active>DockerでRubyOnRails環境を構築</li></ul></nav></header><body class="dark page"></body><main class=post><article><header class=post-header><h1 class=post-title>DockerでRubyOnRails環境を構築</h1><div class=post-meta>2021.08.01</div></header><div class=post-content><h2 id=はじめに>はじめに</h2><p>RubyOnRailsの学習のために、すぐにクリーンな環境を作り直せるDockerで環境構築をしていきます。<br>DockerDesktopはインストール前提です。</p><h2 id=ファイルを作成>ファイルを作成</h2><p>新規でディレクトリを作成します。<br>そのディレクトリに、以下の構成になるようにファイルを作成していきます。</p><pre><code>.
├── Dockerfile
├── Gemfile
├── Gemfile.lock
├── docker-compose.yml
└── entrypoint.sh
</code></pre><h3 id=dockerfile作成>Dockerfile作成</h3><p>Dockerfileという名前でファイルを作成し、以下を記述します。</p><pre><code>FROM ruby:2.7.0

# yarnをインストール
RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - &amp;&amp; \
echo &quot;deb https://dl.yarnpkg.com/debian/ stable main&quot; | tee /etc/apt/sources.list.d/yarn.list

# モジュールインストール
RUN apt-get update -qq &amp;&amp; apt-get install -y nodejs yarn

# rails_appディレクトリを作成し、作業ディレクトリにする
RUN mkdir /rails_app
WORKDIR /rails_app

# GemfileとGemfile.lockをコピーして、bundlerでインストールする
COPY Gemfile /rails_app/Gemfile
COPY Gemfile.lock /rails_app/Gemfile.lock
RUN bundle install
COPY . /rails_app

# railsが特定のpidが実行されていると起動できない問題の解消
COPY entrypoint.sh /usr/bin/
RUN chmod +x /usr/bin/entrypoint.sh
ENTRYPOINT [&quot;entrypoint.sh&quot;]
EXPOSE 3000

# サーバーを起動する
CMD [&quot;rails&quot;, &quot;server&quot;, &quot;-b&quot;, &quot;0.0.0.0&quot;]
</code></pre><h4 id=補足>補足</h4><ul><li><code>apt-get update</code>のオプション<code>-qq</code>は「エラー以外は表示しない」</li><li>COPYとADD<br>COPY: ローカルファイルを再帰的にDocker内にコピーする<br>ADD: COPYとほぼ同じだが、コピー元がアーカイブの場合は展開して使用する。<br>参考:
<a href=https://qiita.com/momotaro98/items/bf34eef176cc2bdb6892 target=_blank>DockerfileにてなぜADDよりCOPYが望ましいのか</a></li><li>CMDとENTRYPOINT<br><code>docker run</code>した際に実行されるコマンドを指定できる。<br>参考:
<a href=https://qiita.com/hihihiroro/items/d7ceaadc9340a4dbeb8f target=_blank>[docker] CMD とENTRYPOINT の違いを試してみた</a></li><li>rails_appディレクトリはRailsの構成が入るディレクトリです</li><li><code>bundle config --local set path 'vendor/bundle'</code>で<code>vendor/bundle</code>以下にgemを配置</li><li>Rails6系では、webpackerが標準になった。<br>またそれに関連して、yarnをインストールが必要になった。<br>そのためまずはyarnのインストールと、webpacker:installの実行が必要。</li></ul><h3 id=docker-composeyml>docker-compose.yml</h3><pre><code>version: '3'
services:
  db:
    image: mysql:5.7
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: root
    ports:
      - &quot;3306:3306&quot;
    volumes:
      - ./tmp/db:/var/lib/mysql

  web:
    build: .
    command: bash -c &quot;rm -f tmp/pids/server.pid &amp;&amp; bundle exec rails s -p 3000 -b '0.0.0.0'&quot;
    volumes:
      - .:/rails_app
    ports:
      - &quot;3000:3000&quot;
    depends_on:
      - db
</code></pre><h3 id=gemfile>Gemfile</h3><pre><code>source 'https://rubygems.org'
gem 'rails', '6.0.3'
</code></pre><h3 id=gemfilelock>Gemfile.lock</h3><p>空ファイルを作成</p><pre><code></code></pre><p><code>Gemfile.lock</code>は直接編集するファイルではなく、<code>bundle install</code>実行時に勝手に更新されるファイル。<br><code>Gemfile.lock</code>が存在する場合は、このファイルに基づいてGEMがインストールされる。</p><h3 id=entrypointsh>entrypoint.sh</h3><p><a href=https://docs.docker.com/samples/rails/ target=_blank>公式Dockerのサイト</a>
に以下のように書いています。</p><blockquote><p>provide an entrypoint script to fix a Rails-specific issue that prevents the server from restarting when a certain server.pid file pre-exists. This script will be executed every time the container gets started.</p></blockquote><p>つまり、特定のpidが残っているとエラーになるので削除するようです。</p><pre><code>#!/bin/bash
set -e

# Remove a potentially pre-existing server.pid for Rails.
rm -f /rails_app/tmp/pids/server.pid

# Then exec the container's main process (what's set as CMD in the Dockerfile).
exec &quot;$@&quot;
</code></pre><h2 id=railsプロジェクトを作成>Railsプロジェクトを作成</h2><h3 id=プロジェクト作成>プロジェクト作成</h3><pre><code>docker-compose run web rails new . --force --no-deps --database=mysql --skip-test --webpacker
</code></pre><ul><li><code>--force</code>: Gemfileを上書き</li><li><code>--no-deps</code>: リンクしたサービスを立ち上げない</li><li><code>--database=mysql</code>: dbはMySQLを使用する</li><li><code>--skip-test</code>: testは作成しない</li><li><code>--webpacker</code>: webpackerをインストールする</li></ul><h3 id=コンテナをビルド>コンテナをビルド</h3><pre><code>docker-compose build
</code></pre><p>Gemfileが更新されているので、再ビルドする。</p><h3 id=データベースの修正>データベースの修正</h3><p>config/database.ymlの内容を以下で上書きします。</p><pre><code>default: &amp;default
  adapter: mysql2
  encoding: utf8mb4
  pool: &lt;%= ENV.fetch(&quot;RAILS_MAX_THREADS&quot;) { 5 } %&gt;
  username: root
  password:
  host: localhost

development:
  &lt;&lt;: *default
  database: myapp_development
  host: db
  username: root
  password: password

test:
  &lt;&lt;: *default
  database: myapp_test
  host: db
  username: root
  password: password
</code></pre><h3 id=db作成>DB作成</h3><pre><code>docker-compose run web rails db:create
</code></pre><p>DBを作成する。</p><h3 id=コンテナを起動>コンテナを起動</h3><pre><code>docker-compose up -d
</code></pre><p>コンテナをバックグラウンドで起動する。</p><h2 id=参考>参考</h2><ul><li><a href=https://zenn.dev/tmasuyama1114/articles/rails-docker-6x-how-to target=_blank>Ruby on Railsの開発環境をDockerで構築する方法(Rails 6.x)</a></li><li><a href=https://docs.docker.com/samples/rails/ target=_blank>Quickstart: Compose and Rails</a></li></ul></div><div class=prev-next></div></article><aside class=aside><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#ファイルを作成>ファイルを作成</a><ul><li><a href=#dockerfile作成>Dockerfile作成</a></li><li><a href=#docker-composeyml>docker-compose.yml</a></li><li><a href=#gemfile>Gemfile</a></li><li><a href=#gemfilelock>Gemfile.lock</a></li><li><a href=#entrypointsh>entrypoint.sh</a></li></ul></li><li><a href=#railsプロジェクトを作成>Railsプロジェクトを作成</a><ul><li><a href=#プロジェクト作成>プロジェクト作成</a></li><li><a href=#コンテナをビルド>コンテナをビルド</a></li><li><a href=#データベースの修正>データベースの修正</a></li><li><a href=#db作成>DB作成</a></li><li><a href=#コンテナを起動>コンテナを起動</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav><h2>関連書籍</h2><div class=amazon><p>Amazon</p><a target=_blank href="https://www.amazon.co.jp/dp/B071YC72X1/ref=nosim?tag=tech-choihack03-22"><img class=amazon-img src="//ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&MarketPlace=JP&ASIN=B071YC72X1&ServiceVersion=20070822&ID=AsinImage&WS=1&Format=_SL350_&tag=tech-choihack03-22"><section class=amazon-title><p>Ruby on Rails 5アプリケーションプログラミング</p></section></a></div><div class="ads side"><h2>おすすめ</h2><iframe src="https://rcm-fe.amazon-adsystem.com/e/cm?o=9&p=21&l=ur1&category=kindleunlimited&banner=178KN9KSS2XDCENS02G2&f=ifr&linkID=81378df7265b0adc45354f106ee4f650&t=tech-choihack03-22&tracking_id=tech-choihack03-22" width=125 height=125 scrolling=no border=0 marginwidth=0 style=border:none frameborder=0></iframe></div></aside></main></body><footer class=footer><h2>本は聴く時代に！圧倒的おすすめ！</h2><iframe src="https://rcm-fe.amazon-adsystem.com/e/cm?o=9&p=12&l=ur1&category=audible&banner=04TW4TSNDNB96FMCBT82&f=ifr&linkID=4522149f1c95f7594ee105cf8eef4890&t=peperon41410c-22&tracking_id=peperon41410c-22" width=300 height=250 scrolling=no border=0 marginwidth=0 style=border:none frameborder=0></iframe><p class=text-center>© - 2021 - こつこつナレッジ</p></footer><script src=https://tech.choihack.com/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script></html>